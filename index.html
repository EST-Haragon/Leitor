<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leitor de C√≥digos com C√¢mera ‚Äî Vers√£o Nota Fiscal (PDF import)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f3f3f3;
    text-align: center;
    padding: 18px;
  }

  #preview {
    width: 100%;
    max-width: 420px;
    height: 320px;
    margin: 0 auto;
    border: 3px solid #555;
    border-radius: 10px;
    background: #000;
    position: relative;
    overflow: hidden;
  }

  #preview canvas {
    width: 100% !important;
    height: 100% !important;
  }

  textarea {
    width: 95%;
    height: 100px;
    font-size: 16px;
    margin-top: 10px;
    resize: vertical;
  }

  button, label {
    margin: 8px;
    padding: 10px 18px;
    font-size: 16px;
    border: none;
    background-color: #007bff;
    color: white;
    border-radius: 8px;
    cursor: pointer;
  }

  label {
    background-color: #28a745;
    cursor: pointer;
  }

  #resultado {
    background: white;
    margin-top: 12px;
    padding: 12px;
    border-radius: 10px;
    min-height: 40px;
  }

  .warning {
    color: #a94442;
    background: #f9e2e2;
    padding: 8px;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 12px;
  }

  .controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }

  #pdfImportLabel {
    background:#17a2b8;
  }

  @media (min-width: 700px) {
    #preview { height: 420px; }
  }

  #progress {
    margin-top: 8px;
    font-size: 14px;
    color: #333;
  }
</style>
</head>
<body>
<h2>üì± Leitor de C√≥digos com C√¢mera ‚Äî Vers√£o Nota Fiscal</h2>
<p>Use a c√¢mera do celular para ler notas fiscais ou importe PDFs contendo c√≥digos para adicionar automaticamente √† lista "esperada". Use em localhost ou HTTPS.</p>

<div id="preview" aria-label="√Årea do preview da c√¢mera"></div>

<div class="controls">
  <button id="btnEsperada">1Ô∏è‚É£ Leitura Esperada</button>
  <button id="btnVerificada">2Ô∏è‚É£ Leitura Verificada</button>
  <button id="btnParar" style="background:#dc3545">‚èπÔ∏è Parar Leitura</button>
  <button id="btnComparar">üîç Comparar</button>
  <button id="btnLimpar" style="background:#6c757d">üßπ Limpar</button>
</div>

<h3>Leituras:</h3>
<textarea id="esperada" placeholder="Primeira leitura..."></textarea>
<textarea id="verificada" placeholder="Segunda leitura..."></textarea>

<br>
<button id="btnExport">üíæ Exportar TXT</button>
<label for="importarTXT">üìÅ Importar TXT</label>
<input type="file" id="importarTXT" accept=".txt" style="display:none" />

<!-- Importar PDF -->
<label for="importarPDF" id="pdfImportLabel">üìÑ Importar PDF</label>
<input type="file" id="importarPDF" accept="application/pdf" style="display:none" />
<div id="progress"></div>

<div id="resultado"></div>

<!-- Fallback video (mostrado apenas se Quagga n√£o carregar, opcional) -->
<video id="fallbackVideo" style="display:none; width:1px; height:1px;" autoplay muted playsinline></video>

<!-- Bibliotecas: Quagga (j√° usado) e pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
/*
  Funcionalidades adicionadas:
  - importa√ß√£o de PDF (input importarPDF)
  - renderiza√ß√£o de cada p√°gina com pdf.js
  - tentativa de detectar barcode via BarcodeDetector (nativo) quando dispon√≠vel
  - fallback para Quagga.decodeSingle quando BarcodeDetector n√£o dispon√≠vel
  - adiciona todos os c√≥digos encontrados √† lista "esperada" (sem duplicatas)
*/

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

const resultadoEl = document.getElementById('resultado');
const previewEl = document.getElementById('preview');
const progressEl = document.getElementById('progress');
const fallbackVideo = document.getElementById('fallbackVideo');

let modoActual = null;
let quaggaStarted = false;
let codigosEsperados = JSON.parse(localStorage.getItem('esperada') || '[]');
let codigosVerificados = JSON.parse(localStorage.getItem('verificada') || '[]');
let lastDetected = { val: null, ts: 0 };

document.getElementById('esperada').value = codigosEsperados.join('\n');
document.getElementById('verificada').value = codigosVerificados.join('\n');

function salvarLocal() {
  localStorage.setItem('esperada', JSON.stringify(codigosEsperados));
  localStorage.setItem('verificada', JSON.stringify(codigosVerificados));
}

function setResultado(html) {
  resultadoEl.innerHTML = html;
}

function setProgress(text) {
  progressEl.textContent = text || '';
}

function isSecureContextAvailable() {
  return (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
}

/* Fun√ß√µes existentes para c√¢mera e Quagga (mantidas) */
function ensureCameraAccessTest() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    return Promise.reject(new Error('API navigator.mediaDevices.getUserMedia n√£o dispon√≠vel neste navegador.'));
  }
  return navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      stream.getTracks().forEach(t => t.stop());
      return Promise.resolve();
    });
}

function iniciarLeitura(tipo) {
  modoActual = tipo;
  setResultado(`<b>Lendo ${tipo === 'esperada' ? 'primeira' : 'segunda'} lista...</b>`);

  if (!isSecureContextAvailable()) {
    setResultado('<div class="warning">Aten√ß√£o: a c√¢mera s√≥ funciona em HTTPS ou em localhost. Execute em localhost ou publique via HTTPS.</div>');
    return;
  }

  if (typeof Quagga === 'undefined') {
    setResultado('<div class="warning">Biblioteca Quagga n√£o carregou. Verifique conex√£o com CDN ou hospede quagga.localmente.</div>');
    startFallbackVideo();
    return;
  }

  ensureCameraAccessTest()
    .then(() => startQuagga())
    .catch(err => {
      console.error('getUserMedia ERRO (pr√©-teste):', err);
      setResultado(`<div class="warning">Erro ao acessar a c√¢mera: ${err && err.message ? err.message : err}. Verifique permiss√µes do site.</div>`);
    });
}

function startQuagga() {
  stopScanning();

  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: previewEl,
      constraints: {
        facingMode: "environment",
        width: { min: 640 },
        height: { min: 480 }
      }
    },
    decoder: {
      readers: [
        "code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader",
        "code_39_reader","i2of5_reader","codabar_reader"
      ]
    },
    locate: true,
    numOfWorkers: navigator.hardwareConcurrency ? Math.max(1, Math.min(4, navigator.hardwareConcurrency - 1)) : 2
  }, function(err) {
    if (err) {
      console.error('Quagga init error:', err);
      setResultado(`<div class="warning">Erro ao iniciar Quagga: ${err.message || err}</div>`);
      startFallbackVideo();
      return;
    }
    Quagga.start();
    quaggaStarted = true;
    setResultado('<b>Scanner ativo. Aponte a c√¢mera para o c√≥digo.</b>');
  });

  Quagga.onProcessed(function(result) {
    const drawingCtx = Quagga.canvas && Quagga.canvas.ctx && Quagga.canvas.ctx.overlay;
    const drawingCanvas = Quagga.canvas && Quagga.canvas.dom && Quagga.canvas.dom.overlay;
    if (!drawingCtx || !drawingCanvas) return;
    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);

    if (result) {
      if (result.boxes) {
        result.boxes.filter(b => b !== result.box).forEach(function(box) {
          Quagga.ImageDebug.drawPath(box, {x:0, y:0}, drawingCtx, {color: "rgba(255,255,255,0.3)", lineWidth: 2});
        });
      }
      if (result.box) {
        Quagga.ImageDebug.drawPath(result.box, {x:0, y:0}, drawingCtx, {color: "#00F", lineWidth: 3});
      }
      if (result.codeResult && result.codeResult.code) {
        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: "red", lineWidth: 3});
      }
    }
  });

  Quagga.offDetected();
  Quagga.onDetected(handleDetected);
}

function handleDetected(result) {
  if (!result || !result.codeResult || !result.codeResult.code) return;
  const codigo = result.codeResult.code.trim();
  const now = Date.now();
  if (lastDetected.val === codigo && (now - lastDetected.ts) < 250) return;
  lastDetected = { val: codigo, ts: now };

  let exibicao = codigo;
  let numeroNota = null;
  if (codigo.length === 44 && /^[0-9]+$/.test(codigo)) {
    const numeroNota = codigo.substring(25, 34);
    exibicao = "NF: " + parseInt(numeroNota, 10);
  }

  if (modoActual === 'esperada') {
    if (!codigosEsperados.includes(exibicao)) codigosEsperados.push(exibicao);
    document.getElementById('esperada').value = codigosEsperados.join('\n');
  } else {
    if (!codigosVerificados.includes(exibicao)) codigosVerificados.push(exibicao);
    document.getElementById('verificada').value = codigosVerificados.join('\n');
  }

  salvarLocal();

  setResultado(
    numeroNota
      ? `<p style="color:green"><b>Nota Fiscal detectada:</b> ${parseInt(numeroNota, 10)}</p>`
      : `<p style="color:blue"><b>C√≥digo detectado:</b> ${codigo}</p>`
  );

  if (navigator.vibrate) navigator.vibrate(80);
}

function stopScanning() {
  if (typeof Quagga !== 'undefined' && quaggaStarted) {
    try { Quagga.stop(); } catch (e) { console.warn('Erro ao parar Quagga:', e); }
    quaggaStarted = false;
  }
  stopFallbackVideo();
  if (typeof Quagga !== 'undefined' && Quagga.canvas && Quagga.canvas.dom && Quagga.canvas.dom.overlay) {
    const overlay = Quagga.canvas.dom.overlay;
    if (overlay && overlay.getContext) {
      const ctx = overlay.getContext('2d');
      ctx && ctx.clearRect(0, 0, overlay.width, overlay.height);
    }
  }
}

function limpar() {
  codigosEsperados = [];
  codigosVerificados = [];
  localStorage.removeItem('esperada');
  localStorage.removeItem('verificada');
  document.getElementById('esperada').value = '';
  document.getElementById('verificada').value = '';
  setResultado('');
  stopScanning();
}

function startFallbackVideo() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    setResultado('<div class="warning">getUserMedia n√£o suportado. N√£o √© poss√≠vel acessar a c√¢mera.</div>');
    return;
  }
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      fallbackVideo.srcObject = stream;
      fallbackVideo.style.display = 'block';
      fallbackVideo.setAttribute('playsinline', '');
      previewEl.innerHTML = '';
      previewEl.appendChild(fallbackVideo);
    })
    .catch(err => {
      console.error('Fallback getUserMedia erro:', err);
      setResultado(`<div class="warning">N√£o foi poss√≠vel abrir a c√¢mera: ${err && err.message ? err.message : err}</div>`);
    });
}

function stopFallbackVideo() {
  if (fallbackVideo && fallbackVideo.srcObject) {
    (fallbackVideo.srcObject.getTracks() || []).forEach(t => t.stop());
    fallbackVideo.srcObject = null;
    fallbackVideo.style.display = 'none';
    previewEl.innerHTML = '';
  }
}

/* Comparar / Export / Import (TXT) */
function comparar() {
  const faltando = codigosEsperados.filter(c => !codigosVerificados.includes(c));
  const aMais = codigosVerificados.filter(c => !codigosEsperados.includes(c));

  let html = "<h3>üìã Resultado da compara√ß√£o</h3>";

  if (faltando.length === 0 && aMais.length === 0) {
    html += `<p style="color:green"><b>Tudo certo!</b> Nenhum item faltando ou extra.</p>`;
  } else {
    if (faltando.length > 0) {
      html += `<p><b style="color:red">Faltando (${faltando.length}):</b><br>${faltando.join('<br>')}</p>`;
    }
    if (aMais.length > 0) {
      html += `<p><b style="color:orange">A mais (${aMais.length}):</b><br>${aMais.join('<br>')}</p>`;
    }
  }

  setResultado(html);
}

function exportarTXT() {
  const dados = { esperada: codigosEsperados, verificada: codigosVerificados };
  const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'dados_codigos.txt';
  a.click();
  URL.revokeObjectURL(url);
}

function importarTXT(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const dados = JSON.parse(e.target.result);
      codigosEsperados = dados.esperada || [];
      codigosVerificados = dados.verificada || [];
      document.getElementById('esperada').value = codigosEsperados.join('\n');
      document.getElementById('verificada').value = codigosVerificados.join('\n');
      salvarLocal();
      alert('‚úÖ Dados importados com sucesso!');
    } catch (erro) {
      alert('‚ùå Arquivo inv√°lido!');
    }
  };
  reader.readAsText(file);
}

/* ==== NOVA FUN√á√ÉO: Importar PDF e detectar c√≥digos ==== */
async function importarPDFFile(file) {
  if (!file) return;
  setProgress('Carregando PDF...');
  setResultado('');
  try {
    const arrayBuffer = await file.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const pdf = await loadingTask.promise;
    const total = pdf.numPages;
    setProgress(`Processando PDF: ${total} p√°gina(s). Isso pode levar alguns segundos...`);

    const foundCodes = []; // c√≥digos detectados neste import

    for (let i = 1; i <= total; i++) {
      setProgress(`Renderizando p√°gina ${i} / ${total}...`);
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: 2.0 }); // escala mais alta para melhor detec√ß√£o
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(viewport.width);
      canvas.height = Math.round(viewport.height);
      const ctx = canvas.getContext('2d');

      await page.render({ canvasContext: ctx, viewport: viewport }).promise;

      // Primeiro tentar BarcodeDetector (nativo e geralmente mais r√°pido)
      let detectedOnPage = [];
      if (window.BarcodeDetector) {
        try {
          // tenta v√°rios formatos comuns
          const formats = ['code_128', 'ean_13', 'ean_8', 'upc_e', 'upc_a', 'code_39', 'itf', 'codabar', 'pdf417', 'qr_code'];
          const supported = await BarcodeDetector.getSupportedFormats ? BarcodeDetector.getSupportedFormats() : formats;
          // filtra formats por supported quando poss√≠vel
          const detectorFormats = (Array.isArray(supported) && supported.length) ? supported : formats;
          const detector = new BarcodeDetector({ formats: detectorFormats });
          const barcodes = await detector.detect(canvas);
          detectedOnPage = (barcodes || []).map(b => (b.rawValue || b.displayValue || '').trim()).filter(Boolean);
        } catch (err) {
          console.warn('BarcodeDetector erro:', err);
          detectedOnPage = [];
        }
      }

      // Se n√£o encontrou via BarcodeDetector, tenta Quagga.decodeSingle (fallback)
      if (detectedOnPage.length === 0) {
        try {
          setProgress(`Detectando (Quagga) na p√°gina ${i}...`);
          // converte canvas para dataURL
          const dataUrl = canvas.toDataURL('image/png');
          const qResult = await new Promise(resolve => {
            Quagga.decodeSingle({
              src: dataUrl,
              numOfWorkers: 0, // decodeSingle roda no main thread
              decoder: {
                readers: [
                  "code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader",
                  "code_39_reader","i2of5_reader","codabar_reader"
                ]
              },
              locate: true
            }, function(result) {
              resolve(result);
            });
          });
          if (qResult && qResult.codeResult && qResult.codeResult.code) {
            detectedOnPage = [qResult.codeResult.code.trim()];
          }
        } catch (err) {
          console.warn('Quagga decodeSingle erro:', err);
        }
      }

      // Adiciona encontrados (evita duplicatas)
      detectedOnPage.forEach(code => {
        if (!code) return;
        // transforma chave NF-e em "NF:nnn" para manter consist√™ncia com leitura por c√¢mera
        let exibicao = code;
        if (/^[0-9]{44}$/.test(code)) {
          const numeroNota = code.substring(25, 34);
          exibicao = 'NF: ' + parseInt(numeroNota, 10);
        }
        if (!foundCodes.includes(exibicao) && !codigosEsperados.includes(exibicao)) {
          foundCodes.push(exibicao);
          codigosEsperados.push(exibicao);
        }
      });

      // libera canvas
      canvas.width = 0;
      canvas.height = 0;
    }

    salvarLocal();
    document.getElementById('esperada').value = codigosEsperados.join('\n');

    if (foundCodes.length > 0) {
      setResultado(`<p style="color:green"><b>C√≥digos importados do PDF:</b><br>${foundCodes.join('<br>')}</p>`);
    } else {
      setResultado('<p style="color:orange"><b>Nenhum c√≥digo detectado no PDF.</b> Tente aumentar a escala ou verificar se o PDF cont√©m imagens leg√≠veis dos c√≥digos.</p>');
    }
    setProgress('');
  } catch (err) {
    console.error('Erro ao processar PDF:', err);
    setResultado(`<div class="warning">Erro ao importar PDF: ${err && err.message ? err.message : err}</div>`);
    setProgress('');
  }
}

/* Event listeners */
document.getElementById('btnEsperada').addEventListener('click', () => iniciarLeitura('esperada'));
document.getElementById('btnVerificada').addEventListener('click', () => iniciarLeitura('verificada'));
document.getElementById('btnParar').addEventListener('click', () => {
  stopScanning();
  setResultado('<b>Scanner parado.</b>');
});
document.getElementById('btnComparar').addEventListener('click', comparar);
document.getElementById('btnLimpar').addEventListener('click', limpar);
document.getElementById('btnExport').addEventListener('click', exportarTXT);
document.getElementById('importarTXT').addEventListener('change', importarTXT);
document.getElementById('importarPDF').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  importarPDFFile(file);
});

/* Label clicks to open file dialogs */
document.getElementById('pdfImportLabel').addEventListener('click', () => {
  document.getElementById('importarPDF').click();
});
document.querySelector('label[for="importarTXT"]').addEventListener('click', () => {
  document.getElementById('importarTXT').click();
});

/* parar c√¢mera ao fechar p√°gina */
window.addEventListener('beforeunload', () => {
  stopScanning();
});

if (!isSecureContextAvailable()) {
  setResultado('<div class="warning">Aten√ß√£o: execute em HTTPS ou localhost para acessar a c√¢mera. A importa√ß√£o de PDF funciona localmente sem HTTPS.</div>');
}
</script>
</body>
</html>
