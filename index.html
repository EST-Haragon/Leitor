<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leitor de C√≥digos com C√¢mera ‚Äî Vers√£o Nota Fiscal (modificado)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f3f3f3;
    text-align: center;
    padding: 18px;
  }

  /* Container do preview (Quagga injeta o v√≠deo internamente neste elemento) */
  #preview {
    width: 100%;
    max-width: 420px;
    height: 320px; /* garante espa√ßo vis√≠vel no layout */
    margin: 0 auto;
    border: 3px solid #555;
    border-radius: 10px;
    background: #000;
    position: relative;
    overflow: hidden;
  }

  /* canvas de overlay (Quagga usa seu pr√≥prio canvas, mas mantemos estilo) */
  #preview canvas {
    width: 100% !important;
    height: 100% !important;
  }

  textarea {
    width: 95%;
    height: 100px;
    font-size: 16px;
    margin-top: 10px;
    resize: vertical;
  }

  button, label {
    margin: 8px;
    padding: 10px 18px;
    font-size: 16px;
    border: none;
    background-color: #007bff;
    color: white;
    border-radius: 8px;
    cursor: pointer;
  }

  label {
    background-color: #28a745;
    cursor: pointer;
  }

  #resultado {
    background: white;
    margin-top: 12px;
    padding: 12px;
    border-radius: 10px;
    min-height: 40px;
  }

  .warning {
    color: #a94442;
    background: #f9e2e2;
    padding: 8px;
    border-radius: 6px;
    display: inline-block;
    margin-bottom: 12px;
  }

  .controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }

  @media (min-width: 700px) {
    #preview { height: 420px; }
  }
</style>
</head>
<body>
<h2>üì± Leitor de C√≥digos com C√¢mera ‚Äî Vers√£o Nota Fiscal</h2>
<p>Use a c√¢mera do celular para ler notas fiscais. Abra em localhost ou em uma URL com HTTPS para que a c√¢mera funcione.</p>

<div id="preview" aria-label="√Årea do preview da c√¢mera"></div>

<div class="controls">
  <button id="btnEsperada">1Ô∏è‚É£ Leitura Esperada</button>
  <button id="btnVerificada">2Ô∏è‚É£ Leitura Verificada</button>
  <button id="btnParar" style="background:#dc3545">‚èπÔ∏è Parar Leitura</button>
  <button id="btnComparar">üîç Comparar</button>
  <button id="btnLimpar" style="background:#6c757d">üßπ Limpar</button>
</div>

<h3>Leituras:</h3>
<textarea id="esperada" placeholder="Primeira leitura..."></textarea>
<textarea id="verificada" placeholder="Segunda leitura..."></textarea>

<br>
<button id="btnExport">üíæ Exportar TXT</button>
<label for="importarTXT">üìÅ Importar TXT</label>
<input type="file" id="importarTXT" accept=".txt" style="display:none" />

<div id="resultado"></div>

<!-- Fallback video (mostrado apenas se Quagga n√£o carregar, opcional) -->
<video id="fallbackVideo" style="display:none; width:1px; height:1px;" autoplay muted playsinline></video>

<!-- Biblioteca QuaggaJS (CDN). Se preferir, baixe localmente e sirva por HTTPS/localhost. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script>
/*
  Vers√£o modificada:
  - Usa um <div id="preview"> como target (Quagga injeta o v√≠deo internamente).
  - Garante altura para o container para evitar 0x0.
  - Verifica se o contexto √© seguro (HTTPS / localhost).
  - Faz uma verifica√ß√£o pr√©via de getUserMedia para capturar erros de permiss√£o rapidamente.
  - Mostra mensagens de erro claras no #resultado.
  - Implementa stopScanning e limpeza apropriada.
  - Mant√©m persist√™ncia em localStorage.
*/

const resultadoEl = document.getElementById('resultado');
const previewEl = document.getElementById('preview');
const fallbackVideo = document.getElementById('fallbackVideo');

let modoActual = null; // 'esperada' ou 'verificada'
let quaggaStarted = false;
let codigosEsperados = JSON.parse(localStorage.getItem('esperada') || '[]');
let codigosVerificados = JSON.parse(localStorage.getItem('verificada') || '[]');
let lastDetected = { val: null, ts: 0 }; // evita leituras repetidas muito r√°pidas

document.getElementById('esperada').value = codigosEsperados.join('\\n');
document.getElementById('verificada').value = codigosVerificados.join('\\n');

function salvarLocal() {
  localStorage.setItem('esperada', JSON.stringify(codigosEsperados));
  localStorage.setItem('verificada', JSON.stringify(codigosVerificados));
}

function setResultado(html) {
  resultadoEl.innerHTML = html;
}

function isSecureContextAvailable() {
  return (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
}

function ensureCameraAccessTest() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    return Promise.reject(new Error('API navigator.mediaDevices.getUserMedia n√£o dispon√≠vel neste navegador.'));
  }
  // Solicita acesso brevemente s√≥ para verificar permiss√µes/disponibilidade.
  return navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      // encerra imediatamente os tracks (Quagga far√° a captura depois)
      stream.getTracks().forEach(t => t.stop());
      return Promise.resolve();
    });
}

function iniciarLeitura(tipo) {
  modoActual = tipo;
  setResultado(`<b>Lendo ${tipo === 'esperada' ? 'primeira' : 'segunda'} lista...</b>`);

  if (!isSecureContextAvailable()) {
    setResultado('<div class="warning">Aten√ß√£o: a c√¢mera s√≥ funciona em HTTPS ou em localhost. Execute em localhost ou publique via HTTPS.</div>');
    return;
  }

  if (typeof Quagga === 'undefined') {
    setResultado('<div class="warning">Biblioteca Quagga n√£o carregou. Verifique conex√£o com CDN ou hospede quagga.localmente.</div>');
    // tentar mostrar fallback de v√≠deo s√≥ para o usu√°rio ver a c√¢mera (opcional)
    startFallbackVideo();
    return;
  }

  // checagem de permiss√£o/disp. de c√¢mera antes de inicializar Quagga
  ensureCameraAccessTest()
    .then(() => {
      startQuagga();
    })
    .catch(err => {
      console.error('getUserMedia ERRO (pr√©-teste):', err);
      setResultado(`<div class="warning">Erro ao acessar a c√¢mera: ${err && err.message ? err.message : err}. Verifique permiss√µes do site.</div>`);
    });
}

function startQuagga() {
  stopScanning(); // garante estado limpo

  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: previewEl, // Quagga injeta o v√≠deo aqui
      constraints: {
        facingMode: "environment",
        width: { min: 640 },
        height: { min: 480 }
      }
    },
    decoder: {
      readers: ["code_128_reader", "ean_reader", "ean_8_reader", "upc_reader"]
    },
    locate: true, // tenta localizar o barcode no frame
    numOfWorkers: navigator.hardwareConcurrency ? Math.max(1, Math.min(4, navigator.hardwareConcurrency - 1)) : 2
  }, function(err) {
    if (err) {
      console.error('Quagga init error:', err);
      setResultado(`<div class="warning">Erro ao iniciar Quagga: ${err.message || err}</div>`);
      // opcional: iniciar fallback de v√≠deo
      startFallbackVideo();
      return;
    }
    Quagga.start();
    quaggaStarted = true;
    setResultado('<b>Scanner ativo. Aponte a c√¢mera para o c√≥digo.</b>');
  });

  // desenha caixas no canvas de overlay (ajuda visual)
  Quagga.onProcessed(function(result) {
    const drawingCtx = Quagga.canvas && Quagga.canvas.ctx && Quagga.canvas.ctx.overlay;
    const drawingCanvas = Quagga.canvas && Quagga.canvas.dom && Quagga.canvas.dom.overlay;
    if (!drawingCtx || !drawingCanvas) return;

    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);

    if (result) {
      if (result.boxes) {
        result.boxes.filter(b => b !== result.box).forEach(function(box) {
          Quagga.ImageDebug.drawPath(box, {x:0, y:0}, drawingCtx, {color: "rgba(255,255,255,0.3)", lineWidth: 2});
        });
      }

      if (result.box) {
        Quagga.ImageDebug.drawPath(result.box, {x:0, y:0}, drawingCtx, {color: "#00F", lineWidth: 3});
      }

      if (result.codeResult && result.codeResult.code) {
        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: "red", lineWidth: 3});
      }
    }
  });

  Quagga.offDetected();
  Quagga.onDetected(handleDetected);
}

function handleDetected(result) {
  if (!result || !result.codeResult || !result.codeResult.code) return;
  const codigo = result.codeResult.code.trim();

  // evita leituras repetidas no curto prazo (200 ms)
  const now = Date.now();
  if (lastDetected.val === codigo && (now - lastDetected.ts) < 250) return;
  lastDetected = { val: codigo, ts: now };

  let exibicao = codigo;
  let numeroNota = null;

  if (codigo.length === 44 && /^[0-9]+$/.test(codigo)) {
    numeroNota = codigo.substring(22, 31); // extrai n√∫mero da nota
    exibicao = "NF: " + parseInt(numeroNota, 10);
  }

  if (modoActual === 'esperada') {
    if (!codigosEsperados.includes(exibicao)) codigosEsperados.push(exibicao);
    document.getElementById('esperada').value = codigosEsperados.join('\\n');
  } else {
    if (!codigosVerificados.includes(exibicao)) codigosVerificados.push(exibicao);
    document.getElementById('verificada').value = codigosVerificados.join('\\n');
  }

  salvarLocal();

  setResultado(
    numeroNota
      ? `<p style="color:green"><b>Nota Fiscal detectada:</b> ${parseInt(numeroNota, 10)}</p>`
      : `<p style="color:blue"><b>C√≥digo detectado:</b> ${codigo}</p>`
  );

  if (navigator.vibrate) navigator.vibrate(80);
}

function stopScanning() {
  if (typeof Quagga !== 'undefined' && quaggaStarted) {
    try {
      Quagga.stop();
    } catch (e) {
      console.warn('Erro ao parar Quagga:', e);
    }
    quaggaStarted = false;
  }
  stopFallbackVideo();
  // limpa canvas overlay (se existir)
  if (typeof Quagga !== 'undefined' && Quagga.canvas && Quagga.canvas.dom && Quagga.canvas.dom.overlay) {
    const overlay = Quagga.canvas.dom.overlay;
    if (overlay && overlay.getContext) {
      const ctx = overlay.getContext('2d');
      ctx && ctx.clearRect(0, 0, overlay.width, overlay.height);
    }
  }
}

function limpar() {
  codigosEsperados = [];
  codigosVerificados = [];
  localStorage.removeItem('esperada');
  localStorage.removeItem('verificada');
  document.getElementById('esperada').value = '';
  document.getElementById('verificada').value = '';
  setResultado('');
  stopScanning();
}

/* Fallback: mostra somente a c√¢mera no <video> se Quagga n√£o estiver dispon√≠vel */
function startFallbackVideo() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    setResultado('<div class="warning">getUserMedia n√£o suportado. N√£o √© poss√≠vel acessar a c√¢mera.</div>');
    return;
  }
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      fallbackVideo.srcObject = stream;
      fallbackVideo.style.display = 'block';
      fallbackVideo.setAttribute('playsinline', '');
      // reposiciona o video dentro do preview para visualiza√ß√£o simples
      previewEl.innerHTML = '';
      previewEl.appendChild(fallbackVideo);
    })
    .catch(err => {
      console.error('Fallback getUserMedia erro:', err);
      setResultado(`<div class="warning">N√£o foi poss√≠vel abrir a c√¢mera: ${err && err.message ? err.message : err}</div>`);
    });
}

function stopFallbackVideo() {
  if (fallbackVideo && fallbackVideo.srcObject) {
    (fallbackVideo.srcObject.getTracks() || []).forEach(t => t.stop());
    fallbackVideo.srcObject = null;
    fallbackVideo.style.display = 'none';
    // restaura preview vazio (Quagga injeta quando inicia)
    previewEl.innerHTML = '';
  }
}

/* Comparar listas */
function comparar() {
  const faltando = codigosEsperados.filter(c => !codigosVerificados.includes(c));
  const aMais = codigosVerificados.filter(c => !codigosEsperados.includes(c));

  let html = "<h3>üìã Resultado da compara√ß√£o</h3>";

  if (faltando.length === 0 && aMais.length === 0) {
    html += `<p style="color:green"><b>Tudo certo!</b> Nenhum item faltando ou extra.</p>`;
  } else {
    if (faltando.length > 0) {
      html += `<p><b style="color:red">Faltando (${faltando.length}):</b><br>${faltando.join('<br>')}</p>`;
    }
    if (aMais.length > 0) {
      html += `<p><b style="color:orange">A mais (${aMais.length}):</b><br>${aMais.join('<br>')}</p>`;
    }
  }

  setResultado(html);
}

/* Export / Import */
function exportarTXT() {
  const dados = { esperada: codigosEsperados, verificada: codigosVerificados };
  const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'dados_codigos.txt';
  a.click();
  URL.revokeObjectURL(url);
}

function importarTXT(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const dados = JSON.parse(e.target.result);
      codigosEsperados = dados.esperada || [];
      codigosVerificados = dados.verificada || [];
      document.getElementById('esperada').value = codigosEsperados.join('\\n');
      document.getElementById('verificada').value = codigosVerificados.join('\\n');
      salvarLocal();
      alert('‚úÖ Dados importados com sucesso!');
    } catch (erro) {
      alert('‚ùå Arquivo inv√°lido!');
    }
  };
  reader.readAsText(file);
}

/* Bot√µes e eventos */
document.getElementById('btnEsperada').addEventListener('click', () => iniciarLeitura('esperada'));
document.getElementById('btnVerificada').addEventListener('click', () => iniciarLeitura('verificada'));
document.getElementById('btnParar').addEventListener('click', () => {
  stopScanning();
  setResultado('<b>Scanner parado.</b>');
});
document.getElementById('btnComparar').addEventListener('click', comparar);
document.getElementById('btnLimpar').addEventListener('click', limpar);
document.getElementById('btnExport').addEventListener('click', exportarTXT);
document.getElementById('importarTXT').addEventListener('change', importarTXT);

/* Se o usu√°rio recarregar/fechar, parar a c√¢mera */
window.addEventListener('beforeunload', () => {
  stopScanning();
});

/* Test r√°pido no carregamento: se n√£o seguro, avisa imediatamente */
if (!isSecureContextAvailable()) {
  setResultado('<div class="warning">Aten√ß√£o: testando em contexto inseguro. Use HTTPS ou localhost para habilitar a c√¢mera.</div>');
}
</script>
</body>
</html>