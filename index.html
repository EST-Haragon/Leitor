<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leitor & Reconcilia√ß√£o ‚Äî NF / Etiquetas</title>

<!-- Bootstrap 5 CSS (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  /* Pequenas customiza√ß√µes al√©m do Bootstrap */
  #preview {
    width: 100%;
    max-width: 100%;
    height: 320px;
    margin: 0 auto;
    border: 3px solid #495057;
    border-radius: 8px;
    background: #000;
    overflow: hidden;
    position: relative;
  }
  #preview canvas { width:100% !important; height:100% !important; }
  #fallbackVideo { width:100%; height:100%; object-fit:cover; display:block; }
  .muted { color:#6c757d; }
  .small-muted { font-size:0.9rem; color:#6c757d; }
  .stat { min-width:120px; }
  .file-label { cursor:pointer; }
  .controls-wrap { gap:.5rem; flex-wrap:wrap; }
  pre.report-json { max-height: 320px; overflow:auto; background:#f8f9fa; padding:12px; border-radius:6px; }
</style>
</head>
<body>
<div class="container py-3">
  <header class="mb-3">
    <h2 class="mb-1">üì¶ Leitor & Reconcilia√ß√£o ‚Äî NF / Etiquetas</h2>
    <p class="small-muted mb-0">Use em localhost ou HTTPS. Meninas importam PDFs com notas; meninos fazem confer√™ncia por leitura. Gera relat√≥rio final e hist√≥rico de incidentes.</p>
  </header>

  <!-- Top: lojas, operador e cria√ß√£o de lote -->
  <div class="card mb-3">
    <div class="card-body">
      <form class="row g-2 align-items-center" onsubmit="return false;">
        <div class="col-auto">
          <label for="storeSelect" class="form-label">Loja</label>
          <select id="storeSelect" class="form-select"></select>
        </div>
        <div class="col-auto">
          <label for="newStore" class="form-label">Nova loja</label>
          <input id="newStore" class="form-control" placeholder="Nome da loja" />
        </div>
        <div class="col-auto align-self-end">
          <button id="addStoreBtn" class="btn btn-outline-success">‚ûï Adicionar loja</button>
        </div>

        <div class="col-auto">
          <label for="operatorInput" class="form-label">Operador</label>
          <input id="operatorInput" class="form-control" placeholder="Nome do operador" />
        </div>

        <div class="col-12 col-md-6">
          <label for="batchName" class="form-label">Nome do lote / expedi√ß√£o</label>
          <input id="batchName" class="form-control" placeholder="Ex.: Shopee - 2025-11-12 - Expedicao A" />
        </div>

        <div class="col-auto align-self-end">
          <button id="createBatchBtn" class="btn btn-primary">üóÇÔ∏è Criar/Selecionar Lote</button>
        </div>

        <div class="col-12">
          <div id="currentBatch" class="small-muted mt-2">Nenhum lote selecionado</div>
        </div>
      </form>
    </div>
  </div>

  <!-- Preview + Controls -->
  <div class="row mb-3">
    <div class="col-12 col-lg-6 mb-3 mb-lg-0">
      <div id="preview" class="mb-2" aria-label="√Årea do preview da c√¢mera"></div>

      <div class="d-flex controls-wrap">
        <button id="btnEsperada" class="btn btn-outline-primary">1Ô∏è‚É£ Leitura Esperada</button>
        <button id="btnVerificada" class="btn btn-outline-success">2Ô∏è‚É£ Leitura Verificada</button>
        <button id="btnParar" class="btn btn-outline-danger">‚èπ Parar</button>
        <button id="btnRegistrarCheck" class="btn btn-info text-white">üìù Registrar verifica√ß√£o atual</button>
        <button id="btnComparar" class="btn btn-secondary">üîç Comparar</button>
        <button id="btnLimpar" class="btn btn-dark">üßπ Limpar listas</button>
      </div>

      <div id="progress" class="small-muted mt-2"></div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="row g-2">
        <div class="col-12">
          <div class="d-flex gap-2 flex-wrap">
            <div class="card stat text-center">
              <div class="card-body p-2">
                <div class="small-muted">Esperada</div>
                <div class="h4 mb-0" id="statEsperada">0</div>
              </div>
            </div>

            <div class="card stat text-center">
              <div class="card-body p-2">
                <div class="small-muted">Verificada</div>
                <div class="h4 mb-0" id="statVerificada">0</div>
              </div>
            </div>

            <div class="card stat text-center">
              <div class="card-body p-2">
                <div class="small-muted">Faltando (final)</div>
                <div class="h4 mb-0" id="statFaltando">0</div>
              </div>
            </div>

            <div class="card stat text-center">
              <div class="card-body p-2">
                <div class="small-muted">Sobrando (final)</div>
                <div class="h4 mb-0" id="statSobrando">0</div>
              </div>
            </div>

            <div class="card stat text-center">
              <div class="card-body p-2">
                <div class="small-muted">Incidentes hoje</div>
                <div class="h4 mb-0" id="statIncidentes">0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">Leituras - Esperada</label>
          <textarea id="esperada" class="form-control" placeholder="Lista esperada (NF/etiquetas)"></textarea>
        </div>

        <div class="col-12">
          <label class="form-label">Leituras - Verificada</label>
          <textarea id="verificada" class="form-control" placeholder="Lista verificada (scanner)"></textarea>
        </div>

        <div class="col-12 d-flex gap-2">
          <button id="btnExport" class="btn btn-outline-secondary">üíæ Exportar TXT</button>

          <label class="btn btn-outline-primary file-label mb-0">
            üìÅ Importar TXT
            <input id="importarTXT" type="file" accept=".txt" hidden>
          </label>

          <label class="btn btn-outline-info file-label mb-0">
            üìÑ Importar PDF
            <input id="importarPDF" type="file" accept="application/pdf" hidden>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Relat√≥rios -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-auto">
          <label for="reportDate" class="form-label">Data do relat√≥rio</label>
          <input id="reportDate" type="date" class="form-control" />
        </div>

        <div class="col-auto">
          <button id="generateReportBtn" class="btn btn-success">üìä Gerar relat√≥rio do dia</button>
        </div>

        <div class="col-auto">
          <button id="exportReportBtn" class="btn btn-secondary">üì§ Exportar relat√≥rio (JSON)</button>
        </div>
      </div>

      <div id="resultado" class="mt-3"></div>
    </div>
  </div>

  <!-- Hidden fallback video -->
  <video id="fallbackVideo" autoplay muted playsinline style="display:none;"></video>
</div>

<!-- Quagga + pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* Bootstrap-based version - mant√©m funcionalidades:
   - lojas, operador, lotes (batches)
   - import PDF detecta c√≥digos e adiciona como esperada
   - c√¢mera + Quagga para leitura esperada/verificada
   - eventos persistidos em localStorage para incident reporting
   - relat√≥rio manual e export JSON
*/

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

/* LocalStorage keys:
   stores -> [string]
   batches -> [{id,name,store,operator,createdAt}]
   events -> [{batchId,store,operator,type,code,display,ts}]
   data_<batchId> -> {esperada:[], verificada:[]}
   reports -> [{date,ts,summary,detail}]
*/

const previewEl = document.getElementById('preview');
const fallbackVideo = document.getElementById('fallbackVideo');
const resultadoEl = document.getElementById('resultado');
const progressEl = document.getElementById('progress');

let stores = JSON.parse(localStorage.getItem('stores') || '[]');
let batches = JSON.parse(localStorage.getItem('batches') || '[]');
let events = JSON.parse(localStorage.getItem('events') || '[]');
let reports = JSON.parse(localStorage.getItem('reports') || '[]');

let currentBatchId = null;
let quaggaStarted = false;
let lastDetected = {val:null, ts:0};
let currentMode = null; // 'esperada' | 'verificada'

/* UI elements */
const storeSelect = document.getElementById('storeSelect');
const newStoreInput = document.getElementById('newStore');
const addStoreBtn = document.getElementById('addStoreBtn');
const operatorInput = document.getElementById('operatorInput');
const batchNameInput = document.getElementById('batchName');
const createBatchBtn = document.getElementById('createBatchBtn');
const currentBatchDiv = document.getElementById('currentBatch');

function saveAll() {
  localStorage.setItem('stores', JSON.stringify(stores));
  localStorage.setItem('batches', JSON.stringify(batches));
  localStorage.setItem('events', JSON.stringify(events));
  localStorage.setItem('reports', JSON.stringify(reports));
}

function refreshStoreSelect() {
  storeSelect.innerHTML = '';
  stores.forEach(s => {
    const opt = document.createElement('option'); opt.value = s; opt.text = s;
    storeSelect.appendChild(opt);
  });
  const optOther = document.createElement('option'); optOther.value=''; optOther.text='-- outra --';
  storeSelect.appendChild(optOther);
}
refreshStoreSelect();

addStoreBtn.addEventListener('click', (e) => {
  e.preventDefault();
  const name = newStoreInput.value.trim();
  if (!name) { alert('Informe o nome da loja.'); return; }
  if (!stores.includes(name)) { stores.push(name); saveAll(); refreshStoreSelect(); }
  newStoreInput.value = '';
});

createBatchBtn.addEventListener('click', (e) => {
  e.preventDefault();
  const name = batchNameInput.value.trim();
  const store = storeSelect.value || (newStoreInput.value.trim() || null);
  const operator = operatorInput.value.trim() || null;
  if (!name || !store) { alert('Informe nome do lote e selecione/adicione a loja.'); return; }
  const id = 'batch_' + Date.now();
  const batch = { id, name, store, operator, createdAt: new Date().toISOString() };
  batches.push(batch);
  saveAll();
  currentBatchId = id;
  saveBatchData(currentBatchId, {esperada:[], verificada:[]});
  updateCurrentBatchUI();
  alert('Lote criado e selecionado: ' + name);
});

function saveBatchData(batchId, data) {
  localStorage.setItem('data_' + batchId, JSON.stringify(data));
}
function loadBatchData(batchId) {
  return JSON.parse(localStorage.getItem('data_' + batchId) || JSON.stringify({esperada:[], verificada:[]}));
}

function updateCurrentBatchUI() {
  if (!currentBatchId) { currentBatchDiv.textContent = 'Nenhum lote selecionado'; updateStats(); return; }
  const b = batches.find(x => x.id === currentBatchId);
  currentBatchDiv.textContent = `Lote: ${b.name} ‚Äî Loja: ${b.store} ‚Äî Operador: ${b.operator || '‚Äî'} ‚Äî Criado: ${new Date(b.createdAt).toLocaleString()}`;
  const data = loadBatchData(currentBatchId);
  document.getElementById('esperada').value = data.esperada.join('\\n');
  document.getElementById('verificada').value = data.verificada.join('\\n');
  updateStats();
}

/* push event */
function pushEvent(ev) {
  events.push(ev);
  saveAll();
  updateStats();
}

/* add expected/verified */
function addExpected(display) {
  if (!currentBatchId) { alert('Crie/seleccione um lote antes.'); return; }
  const data = loadBatchData(currentBatchId);
  if (!data.esperada.includes(display)) {
    data.esperada.push(display);
    saveBatchData(currentBatchId, data);
    document.getElementById('esperada').value = data.esperada.join('\\n');
    pushEvent({ batchId: currentBatchId, store: batches.find(b=>b.id===currentBatchId).store, operator: operatorInput.value || null, type:'add_expected', code:display, display, ts: new Date().toISOString() });
  }
  updateStats();
}

function addVerified(display) {
  if (!currentBatchId) { alert('Crie/seleccione um lote antes.'); return; }
  const data = loadBatchData(currentBatchId);
  if (!data.verificada.includes(display)) {
    data.verificada.push(display);
    saveBatchData(currentBatchId, data);
    document.getElementById('verificada').value = data.verificada.join('\\n');
    pushEvent({ batchId: currentBatchId, store: batches.find(b=>b.id===currentBatchId).store, operator: operatorInput.value || null, type:'add_verified', code:display, display, ts: new Date().toISOString() });
    if (!data.esperada.includes(display)) {
      pushEvent({ batchId: currentBatchId, store: batches.find(b=>b.id===currentBatchId).store, operator: operatorInput.value || null, type:'incident_extra', code:display, display, ts: new Date().toISOString() });
    }
  }
  updateStats();
}

/* snapshot check: mark missing incidents at the moment */
function recordCheckSnapshot() {
  if (!currentBatchId) { alert('Crie/seleccione um lote antes.'); return; }
  const data = loadBatchData(currentBatchId);
  const faltando = data.esperada.filter(x => !data.verificada.includes(x));
  faltando.forEach(code => {
    pushEvent({ batchId: currentBatchId, store: batches.find(b=>b.id===currentBatchId).store, operator: operatorInput.value || null, type:'incident_missing', code, display:code, ts: new Date().toISOString() });
  });
  setResultado(`<div class="alert alert-info">Snapshot registrado: ${faltando.length} item(ns) marcados como faltantes neste lote.</div>`);
}

/* clear lists of current batch (keeps events) */
function clearCurrentLists() {
  if (!currentBatchId) { alert('Crie/seleccione um lote antes.'); return; }
  saveBatchData(currentBatchId, {esperada:[], verificada:[]});
  document.getElementById('esperada').value = '';
  document.getElementById('verificada').value = '';
  setResultado('<div class="alert alert-warning">Listas do lote limpas (o hist√≥rico de eventos permanece).</div>');
  updateStats();
}

/* stats update */
function updateStats() {
  if (!currentBatchId) {
    document.getElementById('statEsperada').textContent = '0';
    document.getElementById('statVerificada').textContent = '0';
    document.getElementById('statFaltando').textContent = '0';
    document.getElementById('statSobrando').textContent = '0';
    document.getElementById('statIncidentes').textContent = '0';
    return;
  }
  const data = loadBatchData(currentBatchId);
  const esperadaSet = new Set(data.esperada);
  const verificadaSet = new Set(data.verificada);
  const faltandoFinal = data.esperada.filter(x => !verificadaSet.has(x));
  const sobrandoFinal = data.verificada.filter(x => !esperadaSet.has(x));
  document.getElementById('statEsperada').textContent = esperadaSet.size;
  document.getElementById('statVerificada').textContent = verificadaSet.size;
  document.getElementById('statFaltando').textContent = faltandoFinal.length;
  document.getElementById('statSobrando').textContent = sobrandoFinal.length;

  const today = new Date().toISOString().slice(0,10);
  const todaysIncidents = events.filter(e => (e.type === 'incident_missing' || e.type === 'incident_extra') && e.ts.slice(0,10) === today && e.batchId === currentBatchId);
  const uniqueIncidentCodes = new Set(todaysIncidents.map(i=>i.code));
  document.getElementById('statIncidentes').textContent = uniqueIncidentCodes.size;
}

/* Camera & Quagga */
function isSecureContextAvailable() {
  return (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
}

function ensureCameraAccessTest() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    return Promise.reject(new Error('API navigator.mediaDevices.getUserMedia n√£o dispon√≠vel.'));
  }
  return navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(s => { s.getTracks().forEach(t => t.stop()); return Promise.resolve(); });
}

function startQuagga() {
  stopScanning();
  if (typeof Quagga === 'undefined') { setResultado('<div class="alert alert-danger">Quagga n√£o carregou.</div>'); return; }
  Quagga.init({
    inputStream: { name:'Live', type:'LiveStream', target: previewEl, constraints:{ facingMode:'environment', width:{min:640}, height:{min:480} } },
    decoder: { readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader","code_39_reader","i2of5_reader","codabar_reader"] },
    locate:true,
    numOfWorkers: navigator.hardwareConcurrency ? Math.max(1, Math.min(4, navigator.hardwareConcurrency-1)) : 2
  }, function(err){
    if (err){ console.error('Quagga init error:',err); setResultado('<div class="alert alert-danger">Erro ao iniciar scanner: '+(err.message||err)+'</div>'); startFallbackVideo(); return; }
    Quagga.start(); quaggaStarted = true; setResultado('<div class="alert alert-success">Scanner ativo</div>');
  });

  Quagga.offDetected();
  Quagga.onDetected(function(result){
    if (!result || !result.codeResult || !result.codeResult.code) return;
    const codigo = result.codeResult.code.trim();
    const now = Date.now();
    if (lastDetected.val === codigo && (now - lastDetected.ts) < 250) return;
    lastDetected = {val:codigo, ts:now};

    let display = codigo;
    if (/^[0-9]{44}$/.test(codigo)) {
      display = 'NF:' + parseInt(codigo.substring(25,34),10);
    }

    if (currentMode === 'esperada') addExpected(display);
    else if (currentMode === 'verificada') addVerified(display);
  });
}

function stopScanning() {
  if (typeof Quagga !== 'undefined' && quaggaStarted) {
    try { Quagga.stop(); } catch(e) { console.warn(e); }
    quaggaStarted = false;
  }
  if (fallbackVideo && fallbackVideo.srcObject) {
    (fallbackVideo.srcObject.getTracks() || []).forEach(t=>t.stop());
    fallbackVideo.srcObject = null;
    fallbackVideo.style.display = 'none';
    previewEl.innerHTML = '';
  }
}

function startFallbackVideo() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    setResultado('<div class="alert alert-danger">getUserMedia n√£o suportado.</div>');
    return;
  }
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      fallbackVideo.srcObject = stream;
      fallbackVideo.style.display = 'block';
      previewEl.innerHTML = '';
      previewEl.appendChild(fallbackVideo);
    })
    .catch(err => { console.error(err); setResultado('<div class="alert alert-danger">N√£o foi poss√≠vel abrir c√¢mera: '+err.message+'</div>'); });
}

/* UI button handlers */
document.getElementById('btnEsperada').addEventListener('click', () => {
  currentMode = 'esperada';
  if (!isSecureContextAvailable()) { setResultado('<div class="alert alert-warning">Use HTTPS/localhost para c√¢mera.</div>'); return; }
  ensureCameraAccessTest().then(()=> startQuagga()).catch(err=> setResultado('<div class="alert alert-danger">Erro acesso c√¢mera: '+err.message+'</div>'));
});
document.getElementById('btnVerificada').addEventListener('click', () => {
  currentMode = 'verificada';
  if (!isSecureContextAvailable()) { setResultado('<div class="alert alert-warning">Use HTTPS/localhost para c√¢mera.</div>'); return; }
  ensureCameraAccessTest().then(()=> startQuagga()).catch(err=> setResultado('<div class="alert alert-danger">Erro acesso c√¢mera: '+err.message+'</div>'));
});
document.getElementById('btnParar').addEventListener('click', () => { stopScanning(); setResultado('<div class="alert alert-secondary">Scanner parado.</div>'); });
document.getElementById('btnRegistrarCheck').addEventListener('click', () => recordCheckSnapshot());
document.getElementById('btnLimpar').addEventListener('click', () => clearCurrentLists());
document.getElementById('btnComparar').addEventListener('click', () => {
  if (!currentBatchId) { alert('Selecione um lote.'); return; }
  const data = loadBatchData(currentBatchId);
  const faltando = data.esperada.filter(x=>!data.verificada.includes(x));
  const aMais = data.verificada.filter(x=>!data.esperada.includes(x));
  let html = '<h5>Resultado da compara√ß√£o</h5>';
  html += `<p><b>Faltando (${faltando.length}):</b><br>${faltando.join('<br>') || '‚Äî'}</p>`;
  html += `<p><b>A mais (${aMais.length}):</b><br>${aMais.join('<br>') || '‚Äî'}</p>`;
  setResultado(html);
});

/* Export / Import TXT */
document.getElementById('btnExport').addEventListener('click', () => {
  if (!currentBatchId) { alert('Selecione um lote.'); return; }
  const data = loadBatchData(currentBatchId);
  const obj = { batchId: currentBatchId, batchInfo: batches.find(b=>b.id===currentBatchId), data };
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type:'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'dados_lote_' + currentBatchId + '.txt'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('importarTXT').addEventListener('change', (e) => {
  const f = e.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const obj = JSON.parse(ev.target.result);
      if ((obj.esperada || obj.verificada) || (obj.data && obj.batchId)) {
        if (!currentBatchId) { alert('Crie/seleccione um lote antes de importar.'); return; }
        const data = loadBatchData(currentBatchId);
        if (obj.esperada) data.esperada = Array.from(new Set([...data.esperada, ...(obj.esperada||[])]));
        if (obj.verificada) data.verificada = Array.from(new Set([...data.verificada, ...(obj.verificada||[])]));
        if (obj.data) {
          data.esperada = Array.from(new Set([...data.esperada, ...(obj.data.esperada||[])]));
          data.verificada = Array.from(new Set([...data.verificada, ...(obj.data.verificada||[])]));
        }
        saveBatchData(currentBatchId, data);
        document.getElementById('esperada').value = data.esperada.join('\\n');
        document.getElementById('verificada').value = data.verificada.join('\\n');
        data.esperada.forEach(d=> pushEvent({ batchId: currentBatchId, store: batches.find(b=>b.id===currentBatchId).store, operator: operatorInput.value||null, type:'add_expected', code:d, display:d, ts:new Date().toISOString() }));
        data.verificada.forEach(d=> pushEvent({ batchId: currentBatchId, store: batches.find(b=>b.id===currentBatchId).store, operator: operatorInput.value||null, type:'add_verified', code:d, display:d, ts:new Date().toISOString() }));
        setResultado('<div class="alert alert-success">Importado TXT para lote atual.</div>');
      } else {
        setResultado('<div class="alert alert-danger">Arquivo TXT inv√°lido.</div>');
      }
    } catch(err) { setResultado('<div class="alert alert-danger">Erro importando TXT: ' + err.message + '</div>'); }
  };
  reader.readAsText(f);
});

/* PDF import: render pages and detect with BarcodeDetector or Quagga decodeSingle */
document.getElementById('importarPDF').addEventListener('change', async (e) => {
  const file = e.target.files[0]; if (!file) return;
  if (!currentBatchId) { alert('Crie/seleccione um lote antes de importar PDF.'); return; }
  setProgress('Carregando PDF...');
  try {
    const arrayBuffer = await file.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const pdf = await loadingTask.promise;
    const total = pdf.numPages;
    setProgress(`Processando PDF: ${total} p√°gina(s)...`);
    const foundCodes = [];
    for (let i = 1; i <= total; i++) {
      setProgress(`P√°gina ${i} / ${total}...`);
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: 2.0 });
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(viewport.width);
      canvas.height = Math.round(viewport.height);
      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;

      let detectedOnPage = [];
      if (window.BarcodeDetector) {
        try {
          const formats = ['code_128','ean_13','ean_8','upc_e','upc_a','code_39','itf','codabar','pdf417','qr_code'];
          const detector = new BarcodeDetector({ formats });
          const barcodes = await detector.detect(canvas);
          detectedOnPage = (barcodes||[]).map(b => (b.rawValue || b.displayValue || '').trim()).filter(Boolean);
        } catch(err) { console.warn('BarcodeDetector err',err); }
      }

      if (detectedOnPage.length === 0) {
        try {
          const dataUrl = canvas.toDataURL('image/png');
          const qResult = await new Promise(resolve => {
            Quagga.decodeSingle({
              src: dataUrl,
              numOfWorkers: 0,
              decoder: { readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader","code_39_reader","i2of5_reader","codabar_reader"] },
              locate: true
            }, function(r){ resolve(r); });
          });
          if (qResult && qResult.codeResult && qResult.codeResult.code) detectedOnPage = [ qResult.codeResult.code.trim() ];
        } catch(err) { console.warn('Quagga decodeSingle err', err); }
      }

      detectedOnPage.forEach(code => {
        let display = code;
        if (/^[0-9]{44}$/.test(code)) {
          display = 'NF:' + parseInt(code.substring(25,34),10);
        }
        if (!foundCodes.includes(display)) foundCodes.push(display);
      });

      canvas.width = 0; canvas.height = 0;
    }

    const data = loadBatchData(currentBatchId);
    foundCodes.forEach(d => {
      if (!data.esperada.includes(d)) {
        data.esperada.push(d);
        pushEvent({ batchId: currentBatchId, store: batches.find(b=>b.id===currentBatchId).store, operator: operatorInput.value||null, type:'add_expected', code:d, display:d, ts:new Date().toISOString() });
      }
    });
    saveBatchData(currentBatchId, data);
    document.getElementById('esperada').value = data.esperada.join('\\n');
    setResultado(`<div class="alert alert-success">Importados do PDF: ${foundCodes.length} c√≥digo(s).</div>`);
    setProgress('');
  } catch(err) {
    console.error(err);
    setResultado('<div class="alert alert-danger">Erro ao processar PDF: ' + (err.message||err) + '</div>');
    setProgress('');
  }
});

/* Report generation (manual) */
document.getElementById('generateReportBtn').addEventListener('click', () => {
  const date = document.getElementById('reportDate').value || (new Date().toISOString().slice(0,10));
  const report = generateDailyReport(date);
  let html = `<h5>Relat√≥rio para ${date}</h5>`;
  html += `<p><b>Total esperada (√∫nicos):</b> ${report.totalEsperada}</p>`;
  html += `<p><b>Total verificada (√∫nicos):</b> ${report.totalVerificada}</p>`;
  html += `<p><b>Faltando (final):</b> ${report.faltando.length}</p>`;
  html += `<p><b>Sobrando (final):</b> ${report.sobrando.length}</p>`;
  html += `<p><b>Incidentes (faltou) √∫nicos:</b> ${report.incidentesFaltou.length}</p>`;
  html += `<p><b>Incidentes (sobrou) √∫nicos:</b> ${report.incidentesSobrou.length}</p>`;
  html += `<details><summary>Faltando (lista)</summary><div class="mt-2">${report.faltando.join('<br>') || '‚Äî'}</div></details>`;
  html += `<details><summary>Sobrando (lista)</summary><div class="mt-2">${report.sobrando.join('<br>') || '‚Äî'}</div></details>`;
  setResultado(html);

  // salvar snapshot no hist√≥rico de reports
  reports.push({ date, ts: new Date().toISOString(), summary: { totalEsperada:report.totalEsperada, totalVerificada:report.totalVerificada, faltando:report.faltando.length, sobrando:report.sobrando.length, incidentesFaltou:report.incidentesFaltou.length, incidentesSobrou:report.incidentesSobrou.length }, detail: report });
  saveAll();
});

document.getElementById('exportReportBtn').addEventListener('click', () => {
  const date = document.getElementById('reportDate').value || (new Date().toISOString().slice(0,10));
  const report = generateDailyReport(date);
  const blob = new Blob([JSON.stringify(report, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `report_${date}.json`; a.click(); URL.revokeObjectURL(url);
});

function generateDailyReport(dateYYYYMMDD) {
  const eventsDay = events.filter(e => e.ts.slice(0,10) === dateYYYYMMDD);
  const batchIds = new Set(eventsDay.map(e=>e.batchId));
  batches.forEach(b => { if (b.createdAt.slice(0,10) === dateYYYYMMDD) batchIds.add(b.id); });

  const report = { date: dateYYYYMMDD, batches: {}, totalEsperada:0, totalVerificada:0, faltando:[], sobrando:[], incidentesFaltou:[], incidentesSobrou:[] };

  batchIds.forEach(batchId => {
    const batch = batches.find(b=>b.id===batchId) || { id:batchId, name:'(desconhecido)', store:'(desconhecido)' };
    const data = loadBatchData(batchId);
    const esperadaSet = new Set(data.esperada);
    const verificadaSet = new Set(data.verificada);
    const faltandoFinal = Array.from(esperadaSet).filter(x => !verificadaSet.has(x));
    const sobrandoFinal = Array.from(verificadaSet).filter(x => !esperadaSet.has(x));
    const inciFaltou = new Set(eventsDay.filter(e=>e.batchId===batchId && e.type==='incident_missing').map(e=>e.code));
    const inciSobrou = new Set(eventsDay.filter(e=>e.batchId===batchId && e.type==='incident_extra').map(e=>e.code));

    report.batches[batchId] = {
      info: batch,
      totalEsperada: esperadaSet.size,
      totalVerificada: verificadaSet.size,
      faltandoFinal,
      sobrandoFinal,
      incidentesFaltou: Array.from(inciFaltou),
      incidentesSobrou: Array.from(inciSobrou),
      events: eventsDay.filter(e=>e.batchId===batchId)
    };

    report.totalEsperada += esperadaSet.size;
    report.totalVerificada += verificadaSet.size;
    report.faltando.push(...faltandoFinal);
    report.sobrando.push(...sobrandoFinal);
    report.incidentesFaltou.push(...Array.from(inciFaltou));
    report.incidentesSobrou.push(...Array.from(inciSobrou));
  });

  report.faltando = Array.from(new Set(report.faltando));
  report.sobrando = Array.from(new Set(report.sobrando));
  report.incidentesFaltou = Array.from(new Set(report.incidentesFaltou));
  report.incidentesSobrou = Array.from(new Set(report.incidentesSobrou));
  return report;
}

/* small helpers */
function setResultado(html) { resultadoEl.innerHTML = html; }
function setProgress(text) { progressEl.textContent = text || ''; }

/* on load: select last batch if exists */
window.addEventListener('load', () => {
  refreshStoreSelect();
  if (batches.length && !currentBatchId) { currentBatchId = batches[batches.length-1].id; }
  updateCurrentBatchUI();
  if (!isSecureContextAvailable()) {
    setResultado('<div class="alert alert-warning">Aten√ß√£o: a c√¢mera funciona apenas em HTTPS ou localhost. Importa√ß√£o de PDF funciona localmente.</div>');
  }
});

/* save when user edits textareas manually */
document.getElementById('esperada').addEventListener('change', () => {
  if (!currentBatchId) return;
  const data = loadBatchData(currentBatchId);
  data.esperada = document.getElementById('esperada').value.split('\\n').map(s=>s.trim()).filter(Boolean);
  saveBatchData(currentBatchId, data);
  data.esperada.forEach(d => pushEvent({ batchId: currentBatchId, store: batches.find(b=>b.id===currentBatchId).store, operator: operatorInput.value||null, type:'add_expected', code:d, display:d, ts:new Date().toISOString() }));
});

document.getElementById('verificada').addEventListener('change', () => {
  if (!currentBatchId) return;
  const data = loadBatchData(currentBatchId);
  data.verificada = document.getElementById('verificada').value.split('\\n').map(s=>s.trim()).filter(Boolean);
  saveBatchData(currentBatchId, data);
  data.verificada.forEach(d => pushEvent({ batchId: currentBatchId, store: batches.find(b=>b.id===currentBatchId).store, operator: operatorInput.value||null, type:'add_verified', code:d, display:d, ts:new Date().toISOString() }));
});

/* storage event to update UI when another tab changes localStorage */
window.addEventListener('storage', () => {
  stores = JSON.parse(localStorage.getItem('stores') || '[]');
  batches = JSON.parse(localStorage.getItem('batches') || '[]');
  events = JSON.parse(localStorage.getItem('events') || '[]');
  refreshStoreSelect();
});

/* End of script */
</script>
</body>
</html>